<!Doctype html lang="English">
<html>
	<head>
		<Title> Local Foods</title>
		
<!-- 				<script async
					src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDQaafaxlkiWcCbgTPy37JNe4uz-4pP2ng&libraries=places&callback=initMap">
				</script> -->
				<script
					src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDQaafaxlkiWcCbgTPy37JNe4uz-4pP2ng&libraries=places&v=weekly"
					defer
				></script>
				<!-- <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDQaafaxlkiWcCbgTPy37JNe4uz-4pP2ng&libraries=places"> -->
	</head>
	
	
	<body>
		<Title> Local Foods</title>
		
		<iframe
			  width="600"
			  height="450"
			  style="border:0"
			  loading="lazy"
			  id = "mapframe"
			  allowfullscreen
			  referrerpolicy="no-referrer-when-downgrade"
			   src="https://www.google.com/maps/embed/v1/place?key=AIzaSyC4Uzg3zthFWP4SrkIgDMAosJywYfARp_g
				&q=Space+Needle,Seattle+WA"
				title = "mapframe">
				
				
				
		</iframe>
		</b>
		<iframe
			  width="600"
			  height="450"
			  style="border:0"
			  loading="lazy"
			  id = "map"
			  allowfullscreen
			  referrerpolicy="no-referrer-when-downgrade"
			   src="https://www.google.com/maps/embed/v1/place?key=AIzaSyC4Uzg3zthFWP4SrkIgDMAosJywYfARp_g
				&q=Space+Needle,Seattle+WA"
				title = "map">
				
				
				
		</iframe>
		
		<p>Click the button to share location data.</p>
	
		<button onclick="getLocation()">Find Me</button>

		<p id="demo"></p>

		<script>
		
		var lat = 0;
		var lon = 0;
//		var map;
//		var service;
//		var infowindow;
//		function callback(results, status) {
//			if (status == google.maps.places.PlacesServiceStatus.OK) {
//				for (var i = 0; i < results.length; i++) {
//					createMarker(results[i]);
//				}
//			}
//		}
		
		
		
		
		var x = document.getElementById("demo");

		function getLocation() {
		  if (navigator.geolocation) {
			navigator.geolocation.getCurrentPosition(showPosition);
		  } else { 
			x.innerHTML = "Geolocation is not supported by this browser.";
		  }
		}

		function showPosition(position) {
		  //x.innerHTML = "Latitude: " + position.coords.latitude + 
		  //"<br>Longitude: " + position.coords.longitude;
		  
		  //TODO 
		  //SET IFRAME.SRC = TO CORRECT QUERY
		  
		  var frame = document.getElementById("mapframe");
		  var search =  position.coords.latitude + "," + position.coords.longitude;
		  lat = position.coords.latitude;
		  lon = position.coords.longitude;
		  //window.query = "Restaurants near " + position.coords.latitude + " " + position.coords.longitude;
		  x.innerHTML = "Restaurants near " + search;
		   var requestOptions = {
			  method: 'GET',
			};
			const reverseGeocodingUrl = "https://api.geoapify.com/v1/geocode/reverse?lat=" + position.coords.latitude +"&lon=" + position.coords.longitude + "&apiKey=fdcf5482f8dc471a9d04308036a0d050";
//			let addr = fetch("https://api.geoapify.com/v1/geocode/reverse?lat=" + position.coords.latitude +"&lon=" + position.coords.longitude + "&apiKey=fdcf5482f8dc471a9d04308036a0d050", requestOptions)
//			  .then(response => response.json())
//			  .then(result => console.log(result))
//			  .catch(error => console.log('error', error));
			fetch(reverseGeocodingUrl).then(result => result.json())
				.then(featureCollection => {
				  if (featureCollection.features.length === 0) {
					document.getElementById("status").textContent = "The address is not found";
					return;
				  }
			var foundAddress = featureCollection.features[0];
			var formatted = foundAddress.properties.formatted;
			var addr1 = foundAddress.properties.address_line1;
			var zipaddr = foundAddress.properties.postcode;
			var first3= addr1.charAt(0) + addr1.charAt(1) + addr1.charAt(2);
			
			let regex = /[0-9][0-9][0-9]/;
			
 			if(regex.test(first3)){
				frame.src = "https://www.google.com/maps/embed/v1/search?key=AIzaSyC4Uzg3zthFWP4SrkIgDMAosJywYfARp_g"
					+ "&q=restaurants+near+" + addr1 +"&zoom=15&center=" + search;
			}
			else{
			frame.src = "https://www.google.com/maps/embed/v1/search?key=AIzaSyC4Uzg3zthFWP4SrkIgDMAosJywYfARp_g"
					+ "&q=restaurants+near+" + zipaddr +"&zoom=15&center=" + search;
			} 
// Places API KEY = AIzaSyDQaafaxlkiWcCbgTPy37JNe4uz-4pP2ng



			

			
//			let service = new google.maps.places.PlacesService(map);
//			var location = new google.maps.LatLng(lat, lon);
			
//			map = new google.maps.Map(document.getElementById('map'), {
//				center: location,
//				zoom: 15
//			});
//			  var request = {
//				location: location,
//				radius: '5000',
//				type: ['restaurant']
//				};
//				
//			service.nearbySearch(request, callback);
			
		  //
		  //var frame = document.querySelector("iframe");
		  //frame.attr('width', 800);
		  //let element = document.querySelector('[title="mapframe"]');
		  //frame.attr('src', "https://www.google.com/maps/embed/v1/place?key=API_KEY"
		   //+ "&q=Restaurants near " + position.coords.latitude + " " + position.coords.longitude";
			});
			//"use strict";
			//Object.defineProperty(exports, "__esModule", { value: true });
			var map;
			var service;
			var infowindow;
			function initMap() {
				var sydney = new google.maps.LatLng(lat, lon);
				infowindow = new google.maps.InfoWindow();
				map = new google.maps.Map(document.getElementById("map"), {
					center: sydney,
					zoom: 15,
				});
				var request = {
					location: sydney,
					radius: '5000',
					type: ['restaurant']
					//query: "Museum of Contemporary Art Australia",
					//fields: ["name", "geometry"],
				};
				service = new google.maps.places.PlacesService(map);
				service.findPlaceFromQuery(request, function (results, status) {
					if (status === google.maps.places.PlacesServiceStatus.OK && results) {
						for (var i = 0; i < results.length; i++) {
							createMarker(results[i]);
						}
						map.setCenter(results[0].geometry.location);
					}
				});
			}
			function createMarker(place) {
				if (!place.geometry || !place.geometry.location)
					return;
				var marker = new google.maps.Marker({
					map: map,
					position: place.geometry.location,
				});
				google.maps.event.addListener(marker, "click", function () {
					infowindow.setContent(place.name || "");
					infowindow.open(map);
				});
			}
			window.initMap = initMap;
			}
		
			
		
		
//		var map;
//		var service;
//		var infowindow;

//		function initMap() {
//			var pyrmont = new google.maps.LatLng(-33.8665433,151.1956316);

//			map = new google.maps.Map(document.getElementById('map'), {
//				center: pyrmont,
//				zoom: 15
//			});

//			var request = {
//				location: pyrmont,
//				radius: '500',
//				type: ['restaurant']
//			};

//			service = new google.maps.places.PlacesService(map);
//			service.nearbySearch(request, callback);
//			}

//			function callback(results, status) {
//				if (status == google.maps.places.PlacesServiceStatus.OK) {
//					for (var i = 0; i < results.length; i++) {
//						createMarker(results[i]);
//					}
//				}
//			}
		
		
		
		
		
		

		</script>

	</body>
</html>